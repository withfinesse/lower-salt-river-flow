<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Live water and weather conditions for the Lower Salt River in Arizona">
    <title>Lower Salt River Conditions</title>
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #f0f8ff;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .header, .footer {
            background-color: #4682b4;
            color: white;
            padding: 15px 0;
            text-align: center;
            width: 100%;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            text-align: center;
            margin: 20px 0;
            width: 90%;
            max-width: 600px;
        }
        .data-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        .data-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 10px;
        }
        .icon {
            font-size: 2em;
            margin-bottom: 10px;
        }
        .version {
            position: absolute;
            top: 10px;
            right: 10px;
            color: lightgray;
        }
        .console-toggle, .refresh-button {
            margin-top: 10px;
            cursor: pointer;
            color: #4682b4;
            text-decoration: underline;
            font-size: 0.9em;
        }
        .debug {
            display: none;
            margin-top: 20px;
            width: 100%;
            height: 200px;
            overflow-y: scroll;
            background: #f8f8f8;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 10px;
            font-size: 0.9em;
            color: #333;
        }
        .hidden {
            display: none;
        }
        .update-section {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            text-align: center;
            margin: 20px 0;
            width: 90%;
            max-width: 600px;
        }
        .dark-mode {
            background-color: #121212;
            color: white;
        }
        .dark-mode .container, .dark-mode .update-section {
            background: #1e1e1e;
            color: white;
        }
        .toggle-dark {
            position: absolute;
            top: 10px;
            left: 10px;
            cursor: pointer;
            color: lightgray;
            font-size: 0.9em;
            text-decoration: underline;
        }
        button.refresh-button {
            background: none;
            border: none;
            color: #4682b4;
            cursor: pointer;
            text-decoration: underline;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
<header class="header">
    <h1>Lower Salt River Conditions</h1>
</header>
<main class="container">
    <button class="refresh-button" onclick="refreshAll()">Refresh Data</button>
    <div class="data-grid">
        <!-- data items unchanged -->
    </div>
    <div class="console-toggle" id="toggle-weather">More weather...</div>
    <div class="version">v5.0.0</div>
    <div class="toggle-dark" onclick="toggleDarkMode()">Toggle Dark Mode</div>
</main>
<section class="update-section">
    <!-- update section unchanged -->
</section>
<footer class="footer">
    <p>Lower Salt River Conditions</p>
</footer>
<div class="console-toggle" id="toggle-console">View Console</div>
<div class="debug" id="debug-log"></div>
<script>
    function refreshAll() {
        fetchWaterData();
        fetchWeatherData();
        fetchObservationData();
    }

    document.addEventListener('DOMContentLoaded', function () {
        const debugLog = document.getElementById('debug-log');
        const toggleConsole = document.getElementById('toggle-console');
        const toggleWeather = document.getElementById('toggle-weather');

        function logDebugMessage(message) {
            const logEntry = document.createElement('div');
            logEntry.textContent = message;
            debugLog.appendChild(logEntry);
            console.log(message);
        }

        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
        }

        toggleConsole.addEventListener('click', function () {
            if (debugLog.style.display === 'none') {
                debugLog.style.display = 'block';
                toggleConsole.textContent = 'Hide Console';
            } else {
                debugLog.style.display = 'none';
                toggleConsole.textContent = 'View Console';
            }
        });

        toggleWeather.addEventListener('click', function () {
            const additionalWeatherItems = ['weather-next-day', 'weather-next-night', 'weather-day-after-next'];
            additionalWeatherItems.forEach(id => {
                const element = document.getElementById(id);
                element.classList.toggle('hidden');
            });
            toggleWeather.textContent = toggleWeather.textContent === 'More weather...' ? 'Less weather...' : 'More weather...';
        });

        function formatDateWithoutSeconds(date) {
            return new Date(date).toLocaleString('en-US', {
                year: 'numeric', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit'
            });
        }

        function degreesToCompass(degrees) {
            const directions = ['N', 'NNE', 'NE', 'ENE', 'E', 'ESE', 'SE', 'SSE', 'S', 'SSW', 'SW', 'WSW', 'W', 'WNW', 'NW', 'NNW'];
            const index = Math.round(degrees / 22.5) % 16;
            return directions[index];
        }

        async function fetchWaterData() {
            logDebugMessage("Fetching water data...");
            try {
                const response = await fetch('https://waterservices.usgs.gov/nwis/iv/?format=json&sites=09502000');
                const data = await response.json();
                const discharge = parseFloat(data.value.timeSeries.find(ts => ts.variable.variableCode[0].value === '00060').values[0].value[0].value);
                const gageHeight = parseFloat(data.value.timeSeries.find(ts => ts.variable.variableCode[0].value === '00065').values[0].value[0].value);
                const precipitation = parseFloat(data.value.timeSeries.find(ts => ts.variable.variableCode[0].value === '00045').values[0].value[0].value);
                const lastUpdateTime = new Date(data.value.timeSeries[0].values[0].value[0].dateTime);

                document.getElementById('flow-data').textContent = `${discharge} cfs`;
                document.getElementById('gage-height').textContent = `${gageHeight} ft`;
                document.getElementById('precipitation').textContent = `${precipitation} in`;
                document.getElementById('usgs-update-time').textContent = formatDateWithoutSeconds(lastUpdateTime);
            } catch (error) {
                logDebugMessage("Error fetching water data: " + error);
            }
        }

        async function fetchObservationData() {
            logDebugMessage("Fetching observation data...");
            try {
                const response = await fetch('https://api.weather.gov/stations/TTBA3/observations/latest');
                const data = await response.json();
                const temperatureF = (data.properties.temperature.value * 9/5) + 32;
                const windSpeed = data.properties.windSpeed.value * 0.621371;
                const windDir = degreesToCompass(data.properties.windDirection.value);
                const obsTime = new Date(data.properties.timestamp);

                document.getElementById('temperature').textContent = `${temperatureF.toFixed(1)} Â°F`;
                document.getElementById('wind-speed').textContent = `${windSpeed.toFixed(1)} mph`;
                document.getElementById('wind-direction').textContent = windDir;
                document.getElementById('observation-update-time').textContent = formatDateWithoutSeconds(obsTime);
            } catch (error) {
                logDebugMessage("Error fetching observation data: " + error);
            }
        }

        async function fetchWeatherData() {
            logDebugMessage("Fetching weather data...");
            try {
                const response = await fetch('https://api.weather.gov/zones/forecast/AZZ547/forecast');
                const data = await response.json();
                const periods = data.properties.periods;
                const updateTime = new Date(data.properties.updated);

                document.getElementById('weather-today-title').textContent = periods[0].name;
                document.getElementById('weather-today-text').innerHTML = periods[0].detailedForecast;
                document.getElementById('weather-tonight-title').textContent = periods[1].name;
                document.getElementById('weather-tonight-text').innerHTML = periods[1].detailedForecast;
                document.getElementById('weather-next-day-title').textContent = periods[2].name;
                document.getElementById('weather-next-day-text').innerHTML = periods[2].detailedForecast;
                document.getElementById('weather-next-night-title').textContent = periods[3].name;
                document.getElementById('weather-next-night-text').innerHTML = periods[3].detailedForecast;
                document.getElementById('weather-day-after-next-title').textContent = periods[4].name;
                document.getElementById('weather-day-after-next-text').innerHTML = periods[4].detailedForecast;
                document.getElementById('weather-update-time').textContent = formatDateWithoutSeconds(updateTime);
            } catch (error) {
                logDebugMessage("Error fetching weather data: " + error);
            }
        }

        refreshAll();
    });
</script>
</body>
</html>
